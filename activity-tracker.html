<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../iron-list/iron-list.html">
<link rel="import" href="../iron-scroll-threshold/iron-scroll-threshold.html">

<script src="../time-elements/time-elements.js"></script>

<!--
An element showing a list of activities, who created it and when.

Example:

    <activity-tracker url="https://requirements-bazaar.org/betaactivities"></activity-tracker>

@group rwth-acis Elements
@element activity-tracker
@demo demo/index.html
@hero hero.svg
-->
<dom-module id="activity-tracker">

  <template>
    <style>
      :host {
        display: block;
        box-sizing: border-box;
        font-size: 14px;
      }

      .creator {
        font-weight: bold;
      }


      p, div, h2 {
        color: #212121;
      }

      p {
        margin: 2px;
      }

      .creationTime {
        opacity: 0.87;
        font-size: small;
      }

      .ellipsis {
        text-overflow: ellipsis;

        /* Required for text-overflow to do anything */
        white-space: nowrap;
        overflow: hidden;
      }

      .multiline-ellipsis {
        margin: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2; /* number of lines to show */
        line-height: 20px;        /* fallback */
        max-height: 60px;       /* fallback */
      }

      .activity-object{
        padding: 2px;
        padding-bottom: 8px;
        display: flex;
        border-bottom: 1px solid gainsboro;
        cursor: pointer;
        cursor: hand;
      }

      .activity-object:hover{
        background-color: lightgray;
      }

      .activity-object > img{
        margin-right: 8px;
        width: 35px;
        height: 35px;
        border-radius: 50%;
      }

      .activity-object > div{
        overflow: auto;
      }

      .activity-title{
        font-weight: bold;
      }

      .loadingIndicator {
        background-color: #0b8043;
        text-align: center;
        height: 44px;
        font: 13px arial;
        line-height: 44px;
        color: white;
      }
    </style>

    <iron-ajax id="activitiesRequest"
      url="[[url]]"
      handle-as="json"
      loading="{{_loadingActivities}}"
      params="{{_params}}"
      on-response="_handleActivitiesResponse"></iron-ajax>

    <iron-list id="activitiesList" items="[[activities]]" as="activity">
      <template>
        <paper-material elevation="0" class="activity-object" on-click="navigateToActivity">

          <img src="[[activity.user.profileImage]]">

            <div>
              <span class="creator">[[activity.user.firstName]] [[activity.user.lastName]]</span>
              <span>[[_calculateActivityMessage(activity)]]</span>
              <div>
                <relative-time class="creationTime" datetime$="{{activity.creationTime}}"></relative-time>
              </div>
            </div>

        </paper-material>
      </template>

    </iron-list>

    <div class="loadingIndicator">Fetching new items...</div>

    <!-- this element will load more data when the user scrolls down and reached the lower threshold -->
    <iron-scroll-threshold id="scrollThreshold"lower-threshold="500"
      on-lower-threshold="_loadMoreData"
      scroll-target="document">
    </iron-scroll-threshold>

  </template>

</dom-module>

<script>

  Polymer({

    is: 'activity-tracker',

    properties: {
      url: {
        type: String,
        value: 'https://requirements-bazaar.org/betaactivities'
      },
      activities: {
        type: Array,
        notify: true,
        value: []
      },
      _params: {
        type: Object,
        notify: true,
        value: {"limit": 30}
      },
      /**
       * true if activities are being loaded.
       */
      _loadingActivities: {
        type: Boolean
      }
    },

    /**
     * Calculates the redirect URL for showing an appropriate frontend for the type of activity.
     *
     */
    navigateToActivity: function(elem){
      window.location = elem.model.__data__.item.dataFrontendUrl;
        /*
         var redirectUrl = '';

         // for a comment, it's the requirements ID
         if (elem.model.__data__.item.dataType === 'PROJECT') {
         redirectUrl = 'https://requirements-bazaar.org/beta/#!/projects/' + elem.model.__data__.item.data.id;
         } else if (elem.model.__data__.item.dataType === 'REQUIREMENT') {
         redirectUrl = 'https://requirements-bazaar.org/beta/#!/projects/' + elem.model.__data__.item.data.projectId + '/components/' + elem.model.__data__.item.data.components[0].id + '/requirements/' + elem.model.__data__.item.data.id;
         }

         if (redirectUrl !== ''){
         window.location = redirectUrl;
         }
         */
    },

    /**
     * Calculates the text that is shown in the activity list entry.
     *
     * @param action the action of the activity.
     * @param type the type of the activity.
     * @param data the data object returned from the server.
     * @returns {string}
     */
    _calculateActivityMessage: function(item) {
      var action = item.activityAction;
      var type = item.dataType;
      var data = item.data;
      var parentData = item.parentData;

      var message = '';
      var actionString = '';
      var typeString = '';
      var dataString = '';

      switch (action) {
        case 'CREATE':
          actionString = 'created';
          break;
        case 'UPDATE':
          actionString = 'updated';
          break;
        case 'DELETE':
          actionString = 'deleted';
          break;
        case 'REALIZE':
          actionString = 'realized';
          break;
        case 'VOTE':
          actionString = 'voted for';
          break;
        case 'UNVOTE':
          actionString = 'unvoted';
          break;
        case 'DEVELOP':
          actionString = 'started developing';
          break;
        case 'UNDEVELOP':
          actionString = 'stopped developing';
          break;
        case 'FOLLOW':
          actionString = 'followed';
          break;
        case 'UNFOLLOW':
          actionString = 'unfollowed';
          break;
      }

      switch (type) {
        case 'PROJECT':
          typeString = 'the project';
          dataString = '"' + data.name + '"';
          break;
        case 'COMPONENT':
          typeString = 'the component';
          dataString = '"' + data.name + '" in the project "' + parentData.name + '"';
          break;
        case 'REQUIREMENT':
          typeString = 'the requirement';
          dataString = '"' + data.title + '"';
          break;
        case 'COMMENT':
          typeString = 'a comment for the requirement';
          dataString = '"' + parentData.title + '"';
          break;
      }

      return actionString + ' ' + typeString + ' ' + dataString + '.';
    },

    _handleActivitiesResponse: function(e) {
      var activitiesResponse = e.detail.response;

      activitiesResponse.forEach(function(activity) {
        //TODO: use unshift if we queried with params "after"
        this.push('activities', activity);
      }.bind(this));

      // Clear the lower threshold so we can load more data when the user scrolls down again.
      this.$.scrollThreshold.clearTriggers();
    },

    _loadMoreData: function() {
      if (this.activities.length > 0){
        this._params = {"limit": 5, "before": this.activities[this.activities.length - 1].id};
      }

      this.$.activitiesRequest.generateRequest();
    },

    appendToActivities: function(){
      if (this.extraActivities){
        for (var i = 0; i <= this.extraActivities.length - 1; i++) {
          this.push("activities", this.extraActivities[i]);
        }
      }
    },

    /**
     * Refreshes the activities from the server.
     */
    refresh: function() {
      //TODO: fix this, we need to either clear activities and load everything, or use the "after" query parameter
      //this.$.activitiesRequest.generateRequest();
    }

  });

</script>
