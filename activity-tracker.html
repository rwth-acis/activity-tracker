<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">

<script src="../time-elements/time-elements.js"></script>

<!--
An element showing a list of activities, who created it and when.

Example:

    <activity-tracker url="https://requirements-bazaar.org/betaactivities"></activity-tracker>

@group rwth-acis Elements
@element activity-tracker
@demo demo/index.html
@hero hero.svg
-->
<dom-module id="activity-tracker">

    <template>
        <style>
            :host {
                display: block;
                box-sizing: border-box;
                font-size: 14px;
            }

            .creator {
                font-weight: bold;
            }


            p, div, h2{
                color: #212121;
            }
            p {
                margin: 2px;
            }

            .creationTime{
                opacity: 0.87;
                font-size: small;
            }
            .ellipsis {
                text-overflow: ellipsis;

                /* Required for text-overflow to do anything */
                white-space: nowrap;
                overflow: hidden;
            }
            .multiline-ellipsis {
                margin: 0;
                overflow: hidden;
                text-overflow: ellipsis;
                display: -webkit-box;
                -webkit-box-orient: vertical;
                -webkit-line-clamp: 2; /* number of lines to show */
                line-height: 20px;        /* fallback */
                max-height: 60px;       /* fallback */
            }
            .activity-object{
                padding: 2px;
                padding-bottom: 8px;
                display: flex;
                border-bottom: 1px solid gainsboro;
                cursor: pointer;
                cursor: hand;
            }
            .activity-object:hover{
                background-color: lightgray;
            }
            .activity-object > img{
                margin-right: 8px;
                width: 35px;
                height: 35px;
                border-radius: 50%;
            }
            .activity-object > div{
                overflow: auto;
            }
            .activity-title{
                font-weight: bold;
            }
        </style>

        <iron-ajax
                id="activitiesLoader"
                url="[[url]]"
                last-response="{{activities}}"
                params='{"page":"0", "per_page":"150"}' auto></iron-ajax>

        <template is="dom-repeat" items="{{activities}}">
            <paper-material elevation="0" class="activity-object" on-click="navigateToActivity">

                <template is="dom-if" if="{{item.user.profileImage}}">
                    <img src="{{item.user.profileImage}}">
                </template>

                <div>
                    <span class="creator">{{item.user.firstName}} {{item.user.lastName}}</span>
                    <span>[[calculateActivityMessage(item)]]</span>
                    <div>
                        <time is="relative-time" class="creationTime" datetime$="[[item.creationTime]]"></time>
                    </div>

                    <!--
                    <p class="ellipsis activity-title">{{item.dataType}}</p>
                    <p class="multiline-ellipsis" style="margin-bottom: 6px">{{item.activityAction}}</p>
                    <p class="time-and-creator">
                        <time class="creationTime" is="relative-time"></time>
                        <span> by </span>
                        <span>{{item.user.userName}}</span>
                    </p>-->

                </div>

            </paper-material>
        </template>
    </template>

</dom-module>

<script>

    Polymer({

        is: 'activity-tracker',

        properties: {
            url: {
                type: String,
                value: 'https://requirements-bazaar.org/betaactivities'
            },
            activities:{
                type: Array
            }
        },


        attached: function() {

            // This is used to set the time for the time element
            this.async(function() {
                // access sibling or parent elements here
                var times = Polymer.dom(this.root).querySelectorAll('.creationTime');

                for (var i in times){
                    times[i].setAttribute('datetime', this.activities[i].creationTime);
                }
            });

            // If a redirectURL is set then turn the cursor into a pointer to show that there is navigation
            if(this.activities){
                var times = Polymer.dom(this.root).querySelectorAll('.activity-object');
                for(var i in times){
                    if(this.activities[i].redirectURL){
                        times[i].style.cursor = 'pointer';
                    }
                }
            }
        },


        /**
         * Calculates the redirect URL for showing an appropriate frontend for the type of activity.
         *
         */
        navigateToActivity: function(elem){
            window.location = elem.model.__data__.item.dataFrontendUrl;
            /*
            var redirectUrl = '';

            // for a comment, it's the requirements ID
            if (elem.model.__data__.item.dataType === 'PROJECT') {
                redirectUrl = 'https://requirements-bazaar.org/beta/#!/projects/' + elem.model.__data__.item.data.id;
            } else if (elem.model.__data__.item.dataType === 'REQUIREMENT') {
                redirectUrl = 'https://requirements-bazaar.org/beta/#!/projects/' + elem.model.__data__.item.data.projectId + '/components/' + elem.model.__data__.item.data.components[0].id + '/requirements/' + elem.model.__data__.item.data.id;
            }

            if (redirectUrl !== ''){
                window.location = redirectUrl;
            }
            */
        },

        /**
         * Calculates the text that is shown in the activity list entry.
         *
         * @param action the action of the activity.
         * @param type the type of the activity.
         * @param data the data object returned from the server.
         * @returns {string}
         */
        calculateActivityMessage: function(item) {
            var action = item.activityAction;
            var type = item.dataType;
            var data = item.data;
            var parentData = item.parentData;

            var message = '';
            var actionString = '';
            var typeString = '';
            var dataString = '';

            switch (action) {
                case 'CREATE':
                    actionString = 'created';
                    break;
                case 'UPDATE':
                    actionString = 'updated';
                    break;
                case 'DELETE':
                    actionString = 'deleted';
                    break;
            }

            switch (type) {
                case 'PROJECT':
                    typeString = 'the project';
                    dataString = '"' + data.name + '"';
                    break;
                case 'COMPONENT':
                    typeString = 'the component';
                    dataString = '"' + data.name + '" in the project "' + parentData.name + '"';
                    break;
                case 'REQUIREMENT':
                    typeString = 'the requirement';
                    dataString = '"' + data.title + '"';
                    break;
                case 'COMMENT':
                    typeString = 'a comment for the requirement';
                    dataString = '"' + parentData.title + '"';
                    break;
            }

            return actionString + ' ' + typeString + ' ' + dataString + '.';
        },

        /**
         * Refreshes the activities from the server.
         */
        refresh: function() {
            this.$.activitiesLoader.generateRequest();
        }

    });

</script>
